<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-N2WWDBK5SV"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-N2WWDBK5SV')</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>DNS Lookup Failure &ndash; Runbooks</title><meta name=description property="og:description" content="When DNS Fails You|"><meta name=apple-mobile-web-app-title content="Runbooks"><link rel=stylesheet href=/runbooks/assets/syntax.css><link rel=stylesheet href=/runbooks/assets/primer-build.css><link rel=stylesheet href=/runbooks/assets/style.css><link rel=stylesheet href=https://containersolutions.github.io/runbooks/custom_style.899dd13784115b34654e51c818307a0a.css></head><body class=bg-gray><div id=holy class="container-lg bg-white h-100"><div id=header class="px-1 bg-white"><nav class="UnderlineNav UnderlineNav--right px-2"><a class="UnderlineNav-actions muted-link h2" href=https://containersolutions.github.io/runbooks/>Runbooks</a><div class="pseudo-menu-item text-gray"><div class=pseudo-flex-item><span class=pseudo-nav-item><a href=https://github.com/containersolutions/runbooks/edit/master/content/posts/networking/dns-lookup-failure.md class=edit-link><svg aria-hidden="true" height="16" role="img" viewBox="0 0 14 16" width="14" class="pencil"><path fill-rule="evenodd" d="M0 12v3h3l8-8-3-3-8 8zm3 2H1v-2h1v1h1v1zm10.3-9.3L12 6 9 3l1.3-1.3a.996.996.0 011.41.0l1.59 1.59c.39.39.39 1.02.0 1.41z"/></svg>&nbsp;
Improve this page</a></span></div></div><div class=UnderlineNav-body><div class="flex-column position-relative dropdown"><span class=UnderlineNav-item>Nav Menu</span><div class="Box Box--condensed position-absolute dropdown-content"><div class=Box-body><a href=/runbooks/>Home</a></div><div class=Box-body><a href=/runbooks/posts/kubernetes/>Kubernetes</a></div><div class=Box-body><a href=/runbooks/posts/linux/>Linux</a></div><div class=Box-body><a href=/runbooks/posts/networking/>Networking</a></div><div class=Box-body><a href=/runbooks/posts/python/>Python</a></div><div class=Box-body><a href=/runbooks/posts/how-to/>How-Tos</a></div><div class=Box-body><a href=/runbooks/posts/golang/>Go</a></div></div></div></div></nav></div><div role=main id=main class="holy-main markdown-body px-4 bg-white"><div class=Subhead><div class=Subhead-heading><div class="h1 mt-3 mb-1">DNS Lookup Failure</div></div><div class=Subhead-description><div class=float-md-right><span title="Lastmod: 2023-01-26. Published at: 0001-01-01.">Lastmod: 2023-01-26</span></div></div></div><article><section class="pb-6 mb-3 border-bottom"><h2 id=overview>Overview</h2><p>This issue happens when a DNS lookup is performed on a Linux system, and an IP address is not returned.</p><h2 id=check-runbook-match>Check RunBook Match</h2><p>If your application is pausing when a network request happens, this runbook may be a match.</p><p>This failure might be intermittent (due to caching of DNS responses in the application), or consistent.</p><p>If the DNS response is <em>delayed</em>, but returns a correct IP address see the <a href=/runbooks/posts/networking/dns-lookup-delay/>DNS lookup delay</a> runbook.</p><p>This runbook assumes you are on a Linux machine.</p><h2 id=initial-steps-overview>Initial Steps Overview</h2><ol><li><p><a href=#step-1>Determine whether the Internet is accessible</a></p></li><li><p><a href=#step-2>Determine whether all DNS lookups are failing</a></p></li><li><p><a href=#step-3>Determine DNS lookup method</a></p></li><li><p><a href=#step-4>Check IPTables</a></p></li><li><p><a href=#step-5>Find Local DNS Server</a></p></li></ol><h2 id=detailed-steps>Detailed Steps</h2><h3 id=step-1>1) Determine whether the Internet is accessible</h3><p>First, check whether you have internet access at all. Surprisingly often, this is the root cause.</p><p>To determine this without relying on DNS lookups, run:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ping -c1 8.8.8.8
</code></pre></div><p>If you see output similar to this:</p><pre><code>64 bytes from 8.8.8.8: icmp_seq=0 ttl=116 time=13.681 ms

--- 8.8.8.8 ping statistics ---
1 packets transmitted, 1 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 13.681/13.681/13.681/0.000 ms
</code></pre><p>then you have internet access.</p><p>If you do not, then the root cause is that you don&rsquo;t.</p><h3 id=step-2>2) Determine whether all DNS lookups are failing</h3><p>Run a DNS lookup against a stable site:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>dig google.com
</code></pre></div><p>The output should look similar to this:</p><pre><code>Server:		192.168.1.25
Address:	192.168.1.254#53

Non-authoritative answer:
Name:	google.com
Address: 216.58.201.46
</code></pre><p>Now run this command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>dig @8.8.8.8 google.com
</code></pre></div><p>Compare the output of the two dig commands you just ran.</p><p>The first two numbers in the IP address in the last line (<code>216.58</code> in the above example output) should match in your output.</p><ul><li><p>If they match, then DNS lookup is working for at least some DNS entries.</p></li><li><p>If they do not match, then DNS lookup is not working on your host.</p></li></ul><p>Note the above outcome down as &lsquo;DNS not working for all&rsquo; or &lsquo;DNS working for some&rsquo;, as it will be used later.</p><h3 id=step-3>3) Determine DNS lookup method</h3><p>There are numerous ways DNS lookups can be performed. We now need to gather some facts about your host to determine what is doing the DNS lookup.</p><h4 id=step-3-1>3.1) <code>nsswitch</code> config</h4><p>Run this command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>grep ^hosts: /etc/nsswitch.conf
</code></pre></div><p>If you see the output:</p><pre><code>grep: /etc/nsswitch.conf: No such file or directory
</code></pre><p>then <strong>note that you are not using nsswitch.</strong></p><p>Otherwise you see output like this:</p><pre><code>/etc/nsswitch.conf:hosts: files dns myhostname
</code></pre><p><strong>Note down the words after &lsquo;&lsquo;hosts:&rsquo;&rsquo; as your &lsquo;nsswitch methods&rsquo;</strong></p><h4 id=step-3-2>3.2) <code>nsswitch</code> host: <code>/etc/hosts</code></h4><p>If you are using nsswitch, and if <code>host</code> was in your <code>nsswitch methods</code>, then check whether the host that&rsquo;s failing is in your <code>/etc/hosts</code> file.</p><p>If it is, then go to <a href=#solution-a>Solution A</a> and edit your <code>/etc/hosts</code> file.</p><h4 id=step-3-3>3.3) <code>nsswitch</code> dns: <code>/resolv.conf</code></h4><p>If you are using nsswitch, and <code>dns</code> <strong>was not</strong> in your &lsquo;nsswitch methods&rsquo; then its absence may be the problem. Try adding it to see if that resolves your issue.</p><p>If you are using nsswitch, and <code>dns</code> <strong>was</strong> in your &lsquo;nsswitch methods&rsquo;, then run this command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>grep ^nameserver /etc/resolv.conf
</code></pre></div><p><strong>Note the output as &lsquo;dns servers in resolv.conf&rsquo; in the order they are seen in the &lsquo;'/etc/resolv.conf&rsquo;' file.</strong></p><h4 id=step-3-4>3.4) Check Nameserver</h4><p>For the first item in your &lsquo;dns servers in resolv.conf&rsquo; list, determine:</p><ul><li><p>Is your DNS server IP address (&lsquo;DNSSIPA&rsquo;) pointed to the localhost network?</p></li><li><p>Is your DNSSIPA pointed to your local network?</p></li><li><p>Is your DNSSIPA pointed to the internet?</p></li></ul><p>To determine the answer to the above, follow the instructions below:</p><ul><li><p>If the DNSSIPA matches: <code>127.0.0.x</code>, where <code>x</code> is any number between <code>0</code> and <code>255</code>, then your DNS server is running locally. Proceed to <a href=#step-5>Find local DNS server</a></p></li><li><p>If your DNSSIPA is in any of the following ranges: <code>10.0.0.0-10.255.255.255</code>, <code>172.16.0.0-172.31.255.255</code>, or <code>192.168.0.0-192.168.255.255</code>, then your DNSSIPA is pointed to a local network. Otherwise, it&rsquo;s likely to be pointed at an internet address. If you&rsquo;re still unsure run: <code>dig +short @8.8.8.8 -x DNSSIPA</code>, where DNSSIPA should be replaced with the actual IP address. If the output is empty then the IPA is pointed to your local network. If it is not empty, then it is pointed to the internet.</p></li><li><p>If your DNSSIPA is pointed at the internet, then proceed to the solution <a href=/runbooks/posts/networking/dns-lookup-delay/#solution-a>here</a>. If that solution does not resolve, continue.</p></li></ul><h3 id=step-4>4) Check IPTables / Netfilter</h3><p>Run this script:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>iptables -vL -t filter | grep -E -w <span style=color:#e6db74>&#39;(53|domain)&#39;</span>
iptables -vL -t nat | grep -E -w <span style=color:#e6db74>&#39;(53|domain)&#39;</span>
iptables -vL -t mangle | grep -E -w <span style=color:#e6db74>&#39;(53|domain)&#39;</span>
iptables -vL -t raw | grep -E -w <span style=color:#e6db74>&#39;(53|domain)&#39;</span>
iptables -vL -t security | grep -E -w <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>(</span>53|domain<span style=color:#f92672>)</span>
</code></pre></div><p>If this produces any output lines at all, it may be that IPTables/NetFilter is diverting the DNS request and causing the issue. Try going to <a href=#solution-b>Solution B</a> to see if that works.</p><p>If you are unsure whether IPTables/NetFilter are in place at all on your system, see <a href=/runbooks/posts/how-to/determine-using-iptables-or-netfilter/>here</a>.</p><p>Your IPTables output might suggest that requests to port 53 are being diverted to another local DNS server (Vagrant&rsquo;s landrush plugin does this, for example). See the next step for more on this.</p><h3 id=step-5>5) Find Local DNS Server</h3><p>If you still have not discovered the cause, then it is possible you have a local DNS server that is intercepting requests and at fault.</p><p><strong>As root</strong>, run:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>lsof -i 4udp@127.0.0.1:53 | grep -v ^COMMAND | awk <span style=color:#e6db74>&#39;{print $1}&#39;</span>
</code></pre></div><p>this will tell you if any program is responding to DNS requests.</p><p>If the output is:</p><ul><li><code>dnsmasq</code>, then dnsmasq may be at fault</li></ul><p>If you want to explore further, there may be other programs listening for UDP requests on your hosts. This command, <em>run as root</em> will show you these:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>lsof -i 4udp@127.0.0.1 | grep -v ^COMMAND | awk <span style=color:#e6db74>&#39;{print $1}&#39;</span>
</code></pre></div><h2 id=solutions-list>Solutions List</h2><p>A) <a href=#solution-a>Edit /etc/hosts</a></p><p>B) <a href=#solution-b>Disable IPTables</a></p><p>C) <a href=#solution-c>Change DNS Server in <code>/etc/resolv.conf</code></a></p><h2 id=solutions-detail>Solutions Detail</h2><h3 id=solution-a>A) Edit <code>/etc/hosts</code></h3><p>Comment out the identified entry in <code>/etc/hosts</code> and go to <a href=#check-resolution>Check Resolution</a>.</p><h3 id=solution-b>B) Disable <code>iptables</code></h3><p>Use <code>systemctl disable</code> (or whichever method of disabling services exists on your system) to disable <code>iptables</code>.</p><p>If it works (see <a href=#check-resolution>Check Resolution</a>), then it may be that IPTables is redirecting your requests to a different location.</p><p>In this case, you will need to determine why this IPTables rule exists and fix accordingly. The fix will be context-dependent.</p><p>Examples of legitimate reasons for doing this include:</p><ul><li>Vagrant plugins (eg Landrush: <a href=https://github.com/vagrant-landrush/landrush/blob/master/README.adoc>https://github.com/vagrant-landrush/landrush/blob/master/README.adoc</a>)</li></ul><h3 id=solution-c>C) Change DNS Server in <code>/etc/resolv.conf</code></h3><p>As root, replace the IP address of the DNS server on the first line beginning <code>nameserver</code> with a public DNS server that is likely to be available, eg Google&rsquo;s DNS server on: <code>8.8.8.8</code>.</p><p>Then go to <a href=#check-resolution>Check Resolution</a>.</p><h2 id=check-resolution>Check Resolution</h2><p>Try running <code>dig</code> or <code>curl</code> against any domains that caused issues before, eg</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>dig google.com
curl google.com
</code></pre></div><p>If they appear to work now, then retry your original application.</p><p>If your original application still fails, it may have cached the bad lookup. A restart of the application may help.</p><p>Whether this fully resolves your issue will depend on the intention behind the design of the network you run on. If you are not fully responsible for it, then you will need to take the information you have gathered here to whoever is responsible for it.</p><h2 id=further-steps>Further Steps</h2><p>None</p><h2 id=further-information>Further Information</h2><p>DNS lookups on Linux can be painfully complicated.</p><p>This series of blog posts may help give context:</p><p><a href=https://zwischenzugs.com/2018/06/08/anatomy-of-a-linux-dns-lookup-part-i/>Anatomy of a DNS Lookup - Part I</a></p><p><a href=https://zwischenzugs.com/2018/06/18/anatomy-of-a-linux-dns-lookup-part-ii/>Anatomy of a DNS Lookup - Part II</a></p><p><a href=https://zwischenzugs.com/2018/07/06/anatomy-of-a-linux-dns-lookup-part-iii/>Anatomy of a DNS Lookup - Part III</a></p><p><a href=https://zwischenzugs.com/2018/08/06/anatomy-of-a-linux-dns-lookup-part-iv/>Anatomy of a DNS Lookup - Part IV</a></p><p><a href=https://zwischenzugs.com/2018/09/13/anatomy-of-a-linux-dns-lookup-part-v-two-debug-nightmares/>Anatomy of a DNS Lookup - Part V</a></p><h2 id=owner>Owner</h2><p><a href=https://github.com/ianmiell>Ian Miell</a></p></section><section><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//runbooks.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></article></div><div id=side class="pr-1 bg-white"><aside class=pr-3><div id=toc class="Box Box--blue mb-3"><b>DNS Lookup Failure</b><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#check-runbook-match>Check RunBook Match</a></li><li><a href=#initial-steps-overview>Initial Steps Overview</a></li><li><a href=#detailed-steps>Detailed Steps</a><ul><li><a href=#step-1>1) Determine whether the Internet is accessible</a></li><li><a href=#step-2>2) Determine whether all DNS lookups are failing</a></li><li><a href=#step-3>3) Determine DNS lookup method</a></li><li><a href=#step-4>4) Check IPTables / Netfilter</a></li><li><a href=#step-5>5) Find Local DNS Server</a></li></ul></li><li><a href=#solutions-list>Solutions List</a></li><li><a href=#solutions-detail>Solutions Detail</a><ul><li><a href=#solution-a>A) Edit <code>/etc/hosts</code></a></li><li><a href=#solution-b>B) Disable <code>iptables</code></a></li><li><a href=#solution-c>C) Change DNS Server in <code>/etc/resolv.conf</code></a></li></ul></li><li><a href=#check-resolution>Check Resolution</a></li><li><a href=#further-steps>Further Steps</a></li><li><a href=#further-information>Further Information</a></li><li><a href=#owner>Owner</a></li></ul></nav></div><div></div></aside></div><div id=footer class="pt-2 pb-3 bg-white text-center"></div></div><div class="container-lg bg-white h-50">&nbsp;</div><div class=footer-container-wrapper><div class=footer-image><a href=https://container-solutions.com><img src=https://containersolutions.github.io/runbooks/images/logo-main.svg class=hs-image-widget style=width:120px;border-width:0;border:0 width=120 alt=logo-main title=logo-main></a></div><div>Runbooks is sponsored by <a href=https://container-solutions.com>Container Solutions</a>. We bring culture, strategy, and technology together<br>&mdash;to make sure your Cloud Native migration is done right. <a href=https://www.container-solutions.com>See how we can help</a></div></div><div class="bg-white h-10"><div class="text-small text-gray credits">Powered by the
<a href=https://github.com/qqhann/hugo-primer class=link-gray-dark>Hugo-Primer</a> theme for
<a href=https://gohugo.io class=link-gray-dark>Hugo</a>.</div></div></body></html>