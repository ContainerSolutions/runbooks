<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-N2WWDBK5SV"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-N2WWDBK5SV')</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>DNS Lookup Delay &ndash; Runbooks</title><meta name=description property="og:description" content="Delay in DNS server response|"><meta name=apple-mobile-web-app-title content="Runbooks"><link rel=stylesheet href=/runbooks/assets/syntax.css><link rel=stylesheet href=/runbooks/assets/primer-build.css><link rel=stylesheet href=/runbooks/assets/style.css><link rel=stylesheet href=https://containersolutions.github.io/runbooks/custom_style.899dd13784115b34654e51c818307a0a.css></head><body class=bg-gray><div id=holy class="container-lg bg-white h-100"><div id=header class="px-1 bg-white"><nav class="UnderlineNav UnderlineNav--right px-2"><a class="UnderlineNav-actions muted-link h2" href=https://containersolutions.github.io/runbooks/>Runbooks</a><div class="pseudo-menu-item text-gray"><div class=pseudo-flex-item><span class=pseudo-nav-item><a href=https://github.com/containersolutions/runbooks/edit/master/content/posts/networking/dns-lookup-delay.md class=edit-link><svg aria-hidden="true" height="16" role="img" viewBox="0 0 14 16" width="14" class="pencil"><path fill-rule="evenodd" d="M0 12v3h3l8-8-3-3-8 8zm3 2H1v-2h1v1h1v1zm10.3-9.3L12 6 9 3l1.3-1.3a.996.996.0 011.41.0l1.59 1.59c.39.39.39 1.02.0 1.41z"/></svg>&nbsp;
Improve this page</a></span></div></div><div class=UnderlineNav-body><div class="flex-column position-relative dropdown"><span class=UnderlineNav-item>Nav Menu</span><div class="Box Box--condensed position-absolute dropdown-content"><div class=Box-body><a href=/runbooks/>Home</a></div><div class=Box-body><a href=/runbooks/posts/kubernetes/>Kubernetes</a></div><div class=Box-body><a href=/runbooks/posts/linux/>Linux</a></div><div class=Box-body><a href=/runbooks/posts/networking/>Networking</a></div><div class=Box-body><a href=/runbooks/posts/python/>Python</a></div><div class=Box-body><a href=/runbooks/posts/how-to/>How-Tos</a></div><div class=Box-body><a href=/runbooks/posts/golang/>Go</a></div></div></div></div></nav></div><div role=main id=main class="holy-main markdown-body px-4 bg-white"><div class=Subhead><div class=Subhead-heading><div class="h1 mt-3 mb-1">DNS Lookup Delay</div></div><div class=Subhead-description><div class=float-md-right><span title="Lastmod: 2023-01-26. Published at: 0001-01-01.">Lastmod: 2023-01-26</span></div></div></div><article><section class="pb-6 mb-3 border-bottom"><h2 id=overview>Overview</h2><p>This issue happens when your application pauses a significant period of time when doing a DNS lookup.</p><h2 id=check-runbook-match>Check RunBook Match</h2><p>If your application regularly pauses when doing anything on the network, but successfully continues, this runbook may help.</p><h2 id=initial-steps-overview>Initial Steps Overview</h2><ol><li><p><a href=#step-1>Gather information</a></p></li><li><p><a href=#step-2>Run lookup on the command line</a></p></li><li><p><a href=#step-3>Subset of URLs?</a></p></li><li><p><a href=#step-4>Using DNSMasq?</a></p></li><li><p><a href=#step-5>IPTables?</a></p></li><li><p><a href=#step-6>IPv6 issue?</a></p></li></ol><h2 id=detailed-steps>Detailed Steps</h2><h3 id=step-1>1) Gather information</h3><h4 id=step-1-1>1.1) Operating system</h4><p>First, determine which OS you are running. See the <a href=/runbooks/posts/how-to/determine-operating-system/>Determine Operating System How-To</a></p><h4 id=step1-2>1.2) DNS servers</h4><p>Next, determine which DNS servers you are using.</p><p>If your OS is <code>Darwin</code>/Mac/iOS, then run</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>scutil --dns &gt; /tmp/runbooks-dns-servers.txt
</code></pre></div><p>and capture the output.</p><p>If your OS is <code>Linux</code>, then run:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cat /etc/resolv.conf | grep ^nameserver &gt; /tmp/runbooks-dns-servers.txt
</code></pre></div><h4 id=step1-3>1.3) Get host you are trying to look up</h4><p>You may need to get this from your application logs.</p><p>If you can&rsquo;t work this out, just use a &lsquo;standard&rsquo; one, like <code>google.com</code>.</p><p>This domain will be referred to as <code>[DOMAIN]</code> from here on.</p><h4 id=step1-4>1.4) Figure Out When This Started</h4><p>If this behaviour was not always happening on this host, then try and work out when it started.</p><h4 id=step1-5>1.5) How widespread is the problem</h4><p>If you can, determine whether this affects <em>all</em> DNS lookups or just a subset.</p><p>If it&rsquo;s just a subset, then you may want to skip to <a href=#step-3>Step 3</a></p><h4 id=step1-5>1.5) Are you running a DNS proxy?</h4><p>A DNS proxy is a program that intercepts DNS requests and replies to DNS requests, or passes them on to other DNS servers. Sometimes these run as local services on the host making the request, to</p><h5 id=step1-5-1>1.5.1) Use <code>netstat</code></h5><p>First try connecting to localhost on port 53 (the standard DNS port) with <code>netstat</code>, eg if you run:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>netstat -l | grep -w <span style=color:#ae81ff>53</span>
</code></pre></div><p>and get a response that contains a line like:</p><pre><code>udp        0      0 127.0.0.53:domain       0.0.0.0:*
</code></pre><p>then you have a server running on the DNS port on your local machine.</p><p>If you have suspicions that a DNS proxy may be running on your host, then running the same command without <code>grep</code>&rsquo;s <code>-w</code> flag may help. Many DNS proxies have <code>53</code> somewhere in their port number (eg see <a href=#step1-5-3>Vagrant landrush</a>, below).</p><h5 id=step1-5-2>1.5.2) DNSMasq?</h5><ul><li>Are you running DNSMasq? Running this may help determine that:</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ps -ef | grep -i dnsmasq
</code></pre></div><h5 id=step1-5-3>1.5.3) Vagrant landrush?</h5><p><a href=https://github.com/vagrant-landrush/landrush>Vagrant landrush</a> is another DNS proxy that can &lsquo;take over&rsquo; your DNS requests. It uses IPTables to divert DNS requests on the host to port 53 to itself. If Landrush can&rsquo;t reply, then it passes the request on to its original destination.</p><p>It uses port <code>10053</code>.</p><h5 id=step1-5-4>1.5.4) Kubernetes?</h5><p>TODO</p><h5 id=step1-5-5>1.5.5) <code>systemd-resolved</code>?</h5><p>It uses port <code>10053</code>.</p><h3 id=step-2>2) Run lookup on the command line</h3><h4 id=step-2-1>2.1) Reproduce problem on the command line</h4><p>First, try and reproduce the problem by running a lookup on your machine, using <code>time</code> to get a report of the time taken, and <code>dig</code> to do the lookup itself:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>time dig <span style=color:#f92672>[</span>DOMAIN<span style=color:#f92672>]</span>
</code></pre></div><p>If you can&rsquo;t reproduce the problem, then it may be that your application is using a different DNS lookup method than your host does.</p><h4 id=step-2-2>2.2) Run lookup against each nameserver in turn</h4><p>Then, do the same lookup on each nameserver you extracted from <a href=#step-1-2>step 1.2</a>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>time dig @1.2.3.4 <span style=color:#f92672>[</span>DOMAIN<span style=color:#f92672>]</span>
</code></pre></div><p>If one of the nameservers is delayed, and the others are fast, consider moving to <a href=#solution-a>Solution A</a></p><h4 id=step-2-3>2.3) Run lookup against a well known DNS server</h4><p>Use a well-known public DNS server, for example Google&rsquo;s <code>8.8.8.8</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>time dig @8.8.8.8 <span style=color:#f92672>[</span>DOMAIN<span style=color:#f92672>]</span>
</code></pre></div><p>to check whether the issue is with the nameservers you are using.</p><h3 id=step-3>3) Subset of URLs?</h3><p>If this issue affects a subset of URLs, then consider:</p><ul><li>do the affected domains return a large DNS response?</li></ul><p>If so, then you may be hitting limits on the size of the DNS response, which in turn trigger <a href=https://en.wikipedia.org/wiki/Maximum_transmission_unit>network MTUs</a> limits, or exceed the RFC length of DNS responses (see size limits <a href=https://tools.ietf.org/html/rfc1035>here</a>).</p><p>This has been seen when enterprises have</p><h3 id=step-4>4) Using DNSMasq?</h3><p>If you are using DNSMasq (a popular local DNS server), consider:</p><h4 id=step-4-1>4.1) DNSMasq config</h4><ul><li>whether DNSMasq could be causing the problem. Config to consider includes:</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>IGNORE_RESOLVCONF<span style=color:#f92672>=</span>yes
</code></pre></div><h4 id=step-4-2>4.2) <code>/etc/resolv.conf</code> DNSMasq Config</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
nameserver <span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>

restart dnsmasq
</code></pre></div><h4 id=step-4-3>4.3) Check DNSMasq logs</h4><p>This may give a clue as to where the issue lies.</p><p>Typically, this will involve running (as root):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>journalctl -u dnsmasq
</code></pre></div><h4 id=step-4-4>4.4) Further information</h4><p>See below for more background that may help, and in <a href=#further-information>further information</a>:</p><p><a href=https://unix.stackexchange.com/posts/418180/revisions>Possible layers involved, along with systemd</a></p><h3 id=step-5>5) IPTables/NetFilter?</h3><p>It may be possible that IPTables/NetFilter is interfering with your DNS request somehow.</p><p>See the <a href=/runbooks/posts/networking/dns-lookup-failure/#step-4>DNS lookup failure article step</a> for more guidance.</p><h3 id=step-6>6) IPv6 issue?</h3><p>If there is no delay when running</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>host <span style=color:#f92672>[</span>DOMAIN<span style=color:#f92672>]</span>
</code></pre></div><p>then the issue may be related to IPv6. See <a href=#solution-c>solution C</a>.</p><h2 id=solutions-list>Solutions List</h2><p>A) <a href=#solution-a>Edit the nameserver list</a></p><p>B) <a href=#solution-b>Reduce the timeout</a></p><p>C) <a href=#solution-c>Disable IPv6</a></p><h2 id=solution-detail>Solution Detail</h2><h3 id=solution-a>A) Edit the nameserver list</h3><p>If you are using Linux, then this is likely to be in <code>/etc/resolv.conf</code>.</p><p>Please be aware of <a href=#further-information-systemd-resolved>systemd</a> when editing <code>/etc/resolv.conf</code>. It is possible that changes to this file will be overwritten.</p><p>If you are using Mac/iOS, then (?TODO?)</p><h3 id=solution-b>B) Reduce the timeout</h3><p>This is less of a solution than a workaround, since it masks the problem. It may help to confirm whether the delay is due to a problem with a specific DNS server among others.</p><p>If you add the line <code>options timeout:1</code> to your <code>/etc/resolv.conf</code> file and see the delay fall to 1 second, then the issue is likely to be with a specific DNS server in your list.</p><h3 id=solution-c>C) Disable IPv6</h3><p>Before applying this solution, be aware that switching off IPv6 may not be advisable if you are using it.</p><p>If you run this as root, then IPv6 will be disabled.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sysctl net.ipv6.conf.all.disable_ipv6<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</code></pre></div><p>TODO: persisting this?</p><h2 id=check-resolution>Check Resolution</h2><p>Your application should no longer be pausing on DNS lookups.</p><h2 id=further-steps>Further Steps</h2><p>None</p><h2 id=further-information>Further Information</h2><h3 id=further-information-links>Links</h3><p><a href=https://en.wikipedia.org/wiki/Maximum_transmission_unit>Network MTUs</a></p><p><a href=http://www.thekelleys.org.uk/dnsmasq/docs/dnsmasq-man.html>DNSMasq Documentation</a></p><p><a href=https://tools.ietf.org/html/rfc1035>RFC1035 - Domain Names - Implementation and Specification</a></p><p><a href=https://unix.stackexchange.com/posts/418180/revisions>DNSMasq layers</a></p><h3 id=further-information-systemd-resolved><code>systemd-resolved</code> and <code>/etc/resolv.conf</code></h3><p>Systemd has made DNS configuration a lot more complicated in recent years.</p><p>There are two systemd services associated with DNS resolution.</p><p><code>systemd-resolved.service</code></p><p><code>resolvconf.service</code></p><p>TODO: more on this, and advice on how to update your configuration</p><h2 id=owner>Owner</h2><p><a href=https://github.com/ianmiell>Ian Miell</a></p></section><section><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//runbooks.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></article></div><div id=side class="pr-1 bg-white"><aside class=pr-3><div id=toc class="Box Box--blue mb-3"><b>DNS Lookup Delay</b><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#check-runbook-match>Check RunBook Match</a></li><li><a href=#initial-steps-overview>Initial Steps Overview</a></li><li><a href=#detailed-steps>Detailed Steps</a><ul><li><a href=#step-1>1) Gather information</a></li><li><a href=#step-2>2) Run lookup on the command line</a></li><li><a href=#step-3>3) Subset of URLs?</a></li><li><a href=#step-4>4) Using DNSMasq?</a></li><li><a href=#step-5>5) IPTables/NetFilter?</a></li><li><a href=#step-6>6) IPv6 issue?</a></li></ul></li><li><a href=#solutions-list>Solutions List</a></li><li><a href=#solution-detail>Solution Detail</a><ul><li><a href=#solution-a>A) Edit the nameserver list</a></li><li><a href=#solution-b>B) Reduce the timeout</a></li><li><a href=#solution-c>C) Disable IPv6</a></li></ul></li><li><a href=#check-resolution>Check Resolution</a></li><li><a href=#further-steps>Further Steps</a></li><li><a href=#further-information>Further Information</a><ul><li><a href=#further-information-links>Links</a></li><li><a href=#further-information-systemd-resolved><code>systemd-resolved</code> and <code>/etc/resolv.conf</code></a></li></ul></li><li><a href=#owner>Owner</a></li></ul></nav></div><div></div></aside></div><div id=footer class="pt-2 pb-3 bg-white text-center"></div></div><div class="container-lg bg-white h-50">&nbsp;</div><div class=footer-container-wrapper><div class=footer-image><a href=https://container-solutions.com><img src=https://containersolutions.github.io/runbooks/images/logo-main.svg class=hs-image-widget style=width:120px;border-width:0;border:0 width=120 alt=logo-main title=logo-main></a></div><div>Runbooks is sponsored by <a href=https://container-solutions.com>Container Solutions</a>. We bring culture, strategy, and technology together<br>&mdash;to make sure your Cloud Native migration is done right. <a href=https://www.container-solutions.com>See how we can help</a></div></div><div class="bg-white h-10"><div class="text-small text-gray credits">Powered by the
<a href=https://github.com/qqhann/hugo-primer class=link-gray-dark>Hugo-Primer</a> theme for
<a href=https://gohugo.io class=link-gray-dark>Hugo</a>.</div></div></body></html>