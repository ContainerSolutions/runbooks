<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-N2WWDBK5SV"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-N2WWDBK5SV')</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Debug Systemd Service Units &ndash; Runbooks</title><meta name=description property="og:description" content="Debugging a systemd service unit file, when systemctl status and journalctl just isn&amp;rsquo;t enough|"><meta name=apple-mobile-web-app-title content="Runbooks"><link rel=stylesheet href=/runbooks/assets/syntax.css><link rel=stylesheet href=/runbooks/assets/primer-build.css><link rel=stylesheet href=/runbooks/assets/style.css><link rel=stylesheet href=https://containersolutions.github.io/runbooks/custom_style.899dd13784115b34654e51c818307a0a.css></head><body class=bg-gray><div id=holy class="container-lg bg-white h-100"><div id=header class="px-1 bg-white"><nav class="UnderlineNav UnderlineNav--right px-2"><a class="UnderlineNav-actions muted-link h2" href=https://containersolutions.github.io/runbooks/>Runbooks</a><div class="pseudo-menu-item text-gray"><div class=pseudo-flex-item><span class=pseudo-nav-item><a href=https://github.com/containersolutions/runbooks/edit/master/content/posts/linux/debug-systemd-service-units.md class=edit-link><svg aria-hidden="true" height="16" role="img" viewBox="0 0 14 16" width="14" class="pencil"><path fill-rule="evenodd" d="M0 12v3h3l8-8-3-3-8 8zm3 2H1v-2h1v1h1v1zm10.3-9.3L12 6 9 3l1.3-1.3a.996.996.0 011.41.0l1.59 1.59c.39.39.39 1.02.0 1.41z"/></svg>&nbsp;
Improve this page</a></span></div></div><div class=UnderlineNav-body><div class="flex-column position-relative dropdown"><span class=UnderlineNav-item>Nav Menu</span><div class="Box Box--condensed position-absolute dropdown-content"><div class=Box-body><a href=/runbooks/>Home</a></div><div class=Box-body><a href=/runbooks/posts/kubernetes/>Kubernetes</a></div><div class=Box-body><a href=/runbooks/posts/linux/>Linux</a></div><div class=Box-body><a href=/runbooks/posts/networking/>Networking</a></div><div class=Box-body><a href=/runbooks/posts/python/>Python</a></div><div class=Box-body><a href=/runbooks/posts/how-to/>How-Tos</a></div><div class=Box-body><a href=/runbooks/posts/golang/>Go</a></div></div></div></div></nav></div><div role=main id=main class="holy-main markdown-body px-4 bg-white"><div class=Subhead><div class=Subhead-heading><div class="h1 mt-3 mb-1">Debug Systemd Service Units</div></div><div class=Subhead-description><div class=float-md-right><span title="Lastmod: 2023-01-26. Published at: 0001-01-01.">Lastmod: 2023-01-26</span></div></div></div><article><section class="pb-6 mb-3 border-bottom"><h2 id=overview>Overview</h2><p>When creating a new service file (or Unit file as they are officially called) it can be very confusing to understand what it&rsquo;s actually attempting to run and what environment it&rsquo;s running within. Your command works fine when you run it in the terminal but when <code>systemd</code> tries the command fails. So what is <code>systemd</code> doing differently?</p><h2 id=check-runbook-match>Check RunBook Match</h2><p>When you run <code>sudo servicectl status &lt;servicename>.service</code> you see an error that looks like this:</p><pre><code>     Loaded: loaded (/etc/systemd/system/ .service; disabled; vendor preset: enabled)
     Active: failed (Result: exit-code) since #; # ago
    Process: # ExecStart=# (code=exited, status=127)
   Main PID: # (code=exited, status=127)

# systemd[1]: : Scheduled restart job, restart counter is at 5.
# systemd[1]: Stopped Test Server.
# systemd[1]: test.service: Start request repeated too quickly.
# systemd[1]: test.service: Failed with result 'exit-code'.
# systemd[1]: Failed to start Test Server.
</code></pre><h2 id=initial-steps-overview>Initial Steps Overview</h2><ol><li><p><a href=#step-1>Check that your Unit Environment variables are correct</a></p></li><li><p><a href=#step-2>Check journalctl for errors</a></p></li><li><p><a href=#step-3>Check the full output of <code>status</code></a></p></li><li><p><a href=#step-4>Try running the command manually in a similar setup</a></p></li></ol><h2 id=detailed-steps>Detailed Steps</h2><h3 id=step-1>1) Unit Environment variables need to be set</h3><p><code>systemd</code> will not inherit the <code>PATH</code> or any other environment variables of the User you have specified in the unit file.</p><p>In an environment where you know your command works try running <code>env</code> and then search through the output for any variables that your command might need. Unless you have specified these in your Unit file, they will not be set. This includes the <code>PATH</code> which is used to determine how to find your service.</p><h4 id=step-1-1>1.1) PATH needs to be set</h4><p>Run this:
<code>env | grep -i ^path</code></p><p>Copy the line you found to your service Unit file, prefixing it with the word <code>Environment=</code></p><p>It might look something like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#a6e22e>Environment</span><span style=color:#f92672>=</span><span style=color:#e6db74>PATH=/home/username/.asdf/shims:/home/username/.asdf/bin:/home/username/bin:/home/username/go/bin:/home/username/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin</span>
</code></pre></div><p>Then reload your service and see if it&rsquo;s working:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>service_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;test.service&#39;</span>
sudo systemctl daemon-reload
sudo systemctl restart <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>service_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
sudo systemctl status <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>service_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</code></pre></div><p>If it&rsquo;s working, make sure to go back and strip it down to the paths you actually need.</p><h4 id=step-1-2>1.2) Other variables</h4><p>While a misconfigured <code>PATH</code> (see <a href=#step-1-1>step 1.1</a>) is usually the cause, many languages depend on other environment variables being set so that they can find packages that they depend on.
eg. GOPATH, CARGO_HOME, GEM_HOME, NODE_PATH, ASDF_DIR etc</p><p>When <code>systemd</code> starts a service it does so in a clean environment, so if you need any environment variables set, then you need to add them to your service unit file: e.g.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#a6e22e>Environment</span><span style=color:#f92672>=</span><span style=color:#e6db74>ASDF_DIR=/home/foo/.asdf</span>
</code></pre></div><h3 id=step-2>2) journalctl</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>journalctl -u &lt;service_name&gt; -f
</code></pre></div><p>Unfortunately, while this command will show you the standard output and standard errors, it will often buffer this output quite differently than if you had run this command directly. This can make it a lot more difficult to link errors to their associated tasks.</p><p>Short of updating your command to not buffer output, you can get around this by installing <code>expect</code> via your Linux package manager. Then you can prefix your <code>ExecStart</code> command with <code>/usr/bin/unbuffer</code> e.g.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo apt install expect
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/bin/unbuffer /path/to/test.py</span>
</code></pre></div><p>This has the downside of introducing another process where things could break.</p><h3 id=step-3>3) systemctl status</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo system status --full --lines<span style=color:#f92672>=</span><span style=color:#ae81ff>50</span> &lt;service-name&gt;
</code></pre></div><p>While this command could give us some useful information, more often than not the logs it shows are simply related to needing to restart too many times. If you remove and <code>Restart=</code> option from your service&rsquo;s Unit file, then you should see far more useful errors.</p><p>Make sure to <code>sudo systemctl daemon-reload</code> and then <code>sudo systemctl restart &lt;service></code> before checking the status again.</p><p>The <code>--full</code> flag makes sure the service path isn&rsquo;t truncated and <code>--lines=&lt;number></code> allows for showing more lines than the default 20.</p><h3 id=step-4>4) Manual execution</h3><p>When all else fails it&rsquo;s time to attempt to emulate what <code>systemd</code> is trying to do and then addressing any errors that arise. You want to make sure you are running the command as the same user and with the exact same environment and command.</p><h4 id=step-4-1>4.1) Constructing the command</h4><p>We want to construct and run something like the following:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo runuser -l &lt;User&gt; -g &lt;Group&gt; -c <span style=color:#e6db74>&#34;cd &lt;WorkingDirectory&gt; &amp;&amp; &lt;EnvironmentFile contents&gt; &lt;Environment&gt; &lt;ExecStart&gt;&#34;</span>
</code></pre></div><p><code>-l &lt;User></code> and <code>-g &lt;Group></code> should use their values from the Unit file or <code>root</code> if not specified.</p><p><code>cd &lt;WorkingDirectory></code> should only be set if there is a value in the Unit file.</p><p><code>&lt;EnvironmentFile contents></code> should just list the simple key-value pairs from this file. Systemd doesn&rsquo;t need quotes around these values so they should be removed or escaped e.g. <code>\"</code>. Not doing so will interfere with the quotes around the command that is being passed to <code>runuser</code>.</p><p><code>&lt;Environment></code> is much the same; just a list of key-value pairs.</p><p>If you have any duplicate environment variables things can get a bit more tricky, in which the value specified last being the one that wins.</p><p>Finally <code>&lt;ExecStart></code> is simply just the value of the command to run.</p><h4 id=step-4-2>4.2) Example</h4><p>In case the section above wasn&rsquo;t clear, here is an example:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># contents of /etc/default/extra</span>
PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/test/bin&#34;</span>
DISPLAY<span style=color:#f92672>=</span>:2
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#75715e># contents of /etc/systemd/system/test.service</span>
<span style=color:#66d9ef>[Unit]</span>
<span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>Amazing Test Service</span>
<span style=color:#a6e22e>After</span><span style=color:#f92672>=</span><span style=color:#e6db74>nginx.service</span>

<span style=color:#66d9ef>[Service]</span>
<span style=color:#a6e22e>Type</span><span style=color:#f92672>=</span><span style=color:#e6db74>simple</span>
<span style=color:#a6e22e>User</span><span style=color:#f92672>=</span><span style=color:#e6db74>deploy</span>
<span style=color:#a6e22e>Environment</span><span style=color:#f92672>=</span><span style=color:#e6db74>NPM_DIR=/home/test/.npm</span>
<span style=color:#a6e22e>EnvironmentFile</span><span style=color:#f92672>=</span><span style=color:#e6db74>-/etc/default/extra</span>
<span style=color:#a6e22e>WorkingDirectory</span><span style=color:#f92672>=</span><span style=color:#e6db74>/home/test/app</span>
<span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/home/test/app/bin/start_server</span>
<span style=color:#a6e22e>Restart</span><span style=color:#f92672>=</span><span style=color:#e6db74>on-failure</span>

<span style=color:#66d9ef>[Install]</span>
<span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>multi-user.target</span>
</code></pre></div><p>This would become the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo runuser -l deploy -c <span style=color:#e6db74>&#34;cd /home/test/app &amp;&amp; PATH=/home/test/bin DISPLAY=:2 NPM_DIR=/home/test/.npm /home/test/app/bin/start_server&#34;</span>
</code></pre></div><p>If you have copied everything correctly, in most cases this should result in the same error that <code>systemd</code> is seeing, but now you have excluded <code>systemd</code> from the problem. I often find at this stage the error becomes very obvious to me as I can instantly see what is different between this and the environment where the command works.</p><p>Common issues are normally, that the user or group is not set up to run this command or it&rsquo;s missing required Environment variables.</p><h4 id=step-4-3>4.3) Cannot reproduce?</h4><p>Unfortunately, <code>systemd</code> is a complicated beast and while the above manual step will cover the most common case, it would be impossible to cover all the possible variants.</p><p>You can however build on this manual command by incorporating more variables from your Unit file until you track down the point of contention. This however will require digging into each of the options to figure out how to translate them into our manual version:
<a href=https://www.freedesktop.org/software/systemd/man/systemd.exec.html>systemd.exec documentation</a></p><h2 id=check-resolution>Check Resolution</h2><p>When successful, the following command should no longer have the output <code>Active: failed</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo system status --full --lines<span style=color:#f92672>=</span><span style=color:#ae81ff>50</span> &lt;service-name&gt;
</code></pre></div><p>If you see <code>Active: inactive (dead)</code> this doesn&rsquo;t mean things are failing, it&rsquo;s just saying that the command has already finished the task and exited.</p><h2 id=further-information>Further Information</h2><p>This is a fantastic overview of the basics of Systemd. I&rsquo;ve linked to partway into the video so that it starts and the useful section: <a href="https://youtu.be/r_haLf5mWhE?t=314">systemd - The Good Parts</a></p><p>General <code>systemd</code> documentation:</p><ul><li><a href=https://www.freedesktop.org/software/systemd/man/systemd.exec.html>systemd.exec</a></li></ul><h2 id=owner>Authors</h2><p><a href=https://github.com/gerrywastaken>Gerry</a></p></section><section><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//runbooks.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></article></div><div id=side class="pr-1 bg-white"><aside class=pr-3><div id=toc class="Box Box--blue mb-3"><b>Debug Systemd Service Units</b><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#check-runbook-match>Check RunBook Match</a></li><li><a href=#initial-steps-overview>Initial Steps Overview</a></li><li><a href=#detailed-steps>Detailed Steps</a><ul><li><a href=#step-1>1) Unit Environment variables need to be set</a></li><li><a href=#step-2>2) journalctl</a></li><li><a href=#step-3>3) systemctl status</a></li><li><a href=#step-4>4) Manual execution</a></li></ul></li><li><a href=#check-resolution>Check Resolution</a></li><li><a href=#further-information>Further Information</a></li><li><a href=#owner>Authors</a></li></ul></nav></div><div></div></aside></div><div id=footer class="pt-2 pb-3 bg-white text-center"></div></div><div class="container-lg bg-white h-50">&nbsp;</div><div class=footer-container-wrapper><div class=footer-image><a href=https://container-solutions.com><img src=https://containersolutions.github.io/runbooks/images/logo-main.svg class=hs-image-widget style=width:120px;border-width:0;border:0 width=120 alt=logo-main title=logo-main></a></div><div>Runbooks is sponsored by <a href=https://container-solutions.com>Container Solutions</a>. We bring culture, strategy, and technology together<br>&mdash;to make sure your Cloud Native migration is done right. <a href=https://www.container-solutions.com>See how we can help</a></div></div><div class="bg-white h-10"><div class="text-small text-gray credits">Powered by the
<a href=https://github.com/qqhann/hugo-primer class=link-gray-dark>Hugo-Primer</a> theme for
<a href=https://gohugo.io class=link-gray-dark>Hugo</a>.</div></div></body></html>